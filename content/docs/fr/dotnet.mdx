---
title: C# / .NET
description: Ce guide vous montre comment int√©grer l'API de paiement de Money Fusion dans une application .NET, que ce soit c√¥t√© backend (ASP.NET Core) ou frontend (MAUI mobile).
---

## üîß C√¥t√© Backend (ASP.NET Core)

### 1. Cr√©ez un mod√®le de requ√™te `FusionPayRequest`

```csharp
public class FusionPayRequest
{
    public decimal totalPrice { get; set; }
    public Article[] article { get; set; }
    public PersonalInfo[] personal_Info { get; set; }
    public string numeroSend { get; set; }
    public string nomclient { get; set; }
    public string return_url { get; set; }
    public string webhook_url { get; set; }
}
```

### 2. Exemple d‚Äôendpoint pour initier un paiement

```csharp
[HttpPost("initiate/{ArticleId}")]
public async Task<IActionResult> InitiateFusionPay(string ArticleId)
{
    var payload = new FusionPayRequest
    {
        totalPrice = 1000,
        article = new[] { new Article { nom = "Nom de l'article", montant = 1000 } },
        personal_Info = new[] { new PersonalInfo { userId = "utilisateur123", orderId = "article123" } },
        numeroSend = "01010101",
        nomclient = "Client Test",
        return_url = "https://votreapp.com/PageDeRemerciement",
        webhook_url = "https://votreapp.com/votre/WebHook"
    };

    var client = _httpClientFactory.CreateClient("FusionPay");
    var response = await client.PostAsJsonAsync("MonApp/cl√©identifiant/pay/", payload);
    var result = await response.Content.ReadFromJsonAsync<FusionPayResponse>();
    return Ok(new { checkoutUrl = result.url });
}
```

## üì± C√¥t√© Frontend (MAUI)

### 1. Ouvrir une WebView avec l‚ÄôURL du paiement

```csharp
PaymentWebView.Source = "https://fusionpay.url/vers/checkout";
```

### 2. Capturer la redirection apr√®s paiement r√©ussi

```csharp
if (e.Url.StartsWith("VotreUrl://personnalis√©", StringComparison.OrdinalIgnoreCase))
{
    await Shell.Current.GoToAsync("//PageDeRedirection");
}
```

## ‚úÖ R√©sultat

- Le paiement est initi√© via Money Fusion.
- L'utilisateur est redirig√© automatiquement vers votre app.
- Le webhook vous notifie de la r√©ussite.

## üéØ Exemple de Webhook (confirmation de paiement)

Lorsque FusionPay re√ßoit un paiement, il envoie une requ√™te HTTP POST √† votre endpoint `fusionpay-webhook`. Voici comment le g√©rer c√¥t√© backend en .NET :

### üéØ Exemple de code C# (.NET) pour le Webhook

```csharp
[AllowAnonymous]
[HttpPost("fusionpay-webhook")]
public async Task<IActionResult> HandleFusionPayWebhook([FromBody] FusionPayWebhook payload)
{
    Debug.WriteLine($"[FusionPay] Webhook re√ßu ‚Äì Token: {payload.tokenPay}, Statut: {payload.statut}");

    if (payload.personal_Info == null || payload.personal_Info.Length == 0)
        return BadRequest(new { Message = "Donn√©es invalides." });

    var transactionId = payload.tokenPay;
    var userId = payload.personal_Info[0].userId;
    var articleId = payload.personal_Info[0].orderId;

    var alreadyProcessed = await _context.PurchasedArticles
        .AnyAsync(p => p.TransactionId == transactionId);

    if (alreadyProcessed)
        return Ok(new { Message = "D√©j√† trait√©" });

    if (payload.statut == "paid")
    {
        var article = await _context.Articles.FindAsync(aricleId);
        if (article == null)
            return NotFound("Article non trouv√©");

        var purchase = new PurchasedArticle
        {
            UserId = userId,
            ArticleId = articleId,
            TransactionId = transactionId,
            PurchaseDate = DateTime.UtcNow,
            Title = article.Title,
            Price = article.Price,
            Description = article.Description,
        };

        _context.PurchasedArticles.Add(purchase);

        var pending = await _context.PendingPayments
            .FirstOrDefaultAsync(p => p.TransactionId == transactionId);

        if (pending != null)
            pending.IsCompleted = true;

        await _context.SaveChangesAsync();

        return Ok(new { Message = "Paiement confirm√© et livre ajout√©." });
    }

    return BadRequest(new { Message = "Paiement non accept√©", payload.statut });
}
```

### üì¶ Exemple de donn√©es re√ßues (JSON)

```json
{
  "tokenPay": "ABC123456",
  "statut": "paid",
  "personal_Info": [
    {
      "userId": "UTILISATEUR123",
      "orderId": "LIVRE456"
    }
  ]
}
```
